<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoxShelvInv - Home Inventory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: white;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            align-items: center;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-add-shelf {
            background: linear-gradient(45deg, #48dbfb, #0abde3);
        }

        .btn-add-box {
            background: linear-gradient(45deg, #ff9ff3, #ff6b9d);
        }

        .btn-undo {
            background: linear-gradient(45deg, #feca57, #ff9ff3);
        }

        .search-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .search-bar {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            outline: none;
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
            transform: scale(1.02);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 18px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .shelf, .box {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            animation: slideUp 0.5s ease-out;
            cursor: pointer;
        }

        .shelf.minimized, .box.minimized {
            padding: 15px;
            cursor: pointer;
        }

        .shelf.minimized:hover, .box.minimized:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .shelf.expanded, .box.expanded {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }

        .shelf {
            border-left: 5px solid #48dbfb;
        }

        .box {
            border-left: 5px solid #ff9ff3;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .item-header.minimized {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .minimized-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .item-count {
            background: linear-gradient(45deg, #10ac84, #00d2d3);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .expand-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .expand-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }

        .content-area {
            display: block;
        }

        .content-area.hidden {
            display: none;
        }

        .item-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
        }

        .item-number {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .delete-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .delete-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255,107,107,0.3);
        }

        .add-item-form {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .item-input {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .item-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.2);
        }

        .add-item-btn {
            background: linear-gradient(45deg, #10ac84, #00d2d3);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .add-item-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16,172,132,0.3);
        }

        .items-list {
            margin-top: 15px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            transition: all 0.3s ease;
            animation: itemFadeIn 0.3s ease-out;
        }

        @keyframes itemFadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .item:hover {
            background: linear-gradient(45deg, #e9ecef, #dee2e6);
            transform: translateX(5px);
        }

        .item-name {
            font-weight: 500;
            color: #333;
        }

        .item-delete-btn {
            background: #ff6b6b;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .item-delete-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10ac84, #00d2d3);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: all 0.3s ease;
            z-index: 1000;
            font-weight: bold;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-width: 120px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .logo {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .add-item-form {
                flex-direction: column;
            }

            .item-input {
                min-width: auto;
            }

            .stats {
                flex-direction: column;
                align-items: center;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Pulse animation for new items */
        .pulse {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="logo">BoxShelvInv</h1>
            <p class="subtitle">Smart Home Inventory Management</p>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="shelfCount">0</div>
                <div class="stat-label">Shelves</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="boxCount">0</div>
                <div class="stat-label">Boxes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="itemCount">0</div>
                <div class="stat-label">Total Items</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-add-shelf" onclick="addShelf()">📚 Add Shelf</button>
            <button class="btn btn-add-box" onclick="addBox()">📦 Add Box</button>
            <button class="btn btn-undo" onclick="undoDelete()">↶ Undo Delete</button>
            <button class="btn" id="viewToggle" onclick="toggleViewMode()">📋 Minimize All</button>
            <button class="btn" onclick="exportInventory()">💾 Export JSON</button>
            <button class="btn" onclick="importInventory()">📁 Import JSON</button>
        </div>
        
        <!-- Hidden file input for import -->
        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

        <div class="search-container">
            <input type="text" class="search-bar" id="searchBar" placeholder="Search items, shelves, or boxes..." onkeyup="searchItems()">
            <span class="search-icon">🔍</span>
        </div>

        <div class="inventory-grid" id="inventoryGrid">
            <!-- Shelves and boxes will be dynamically added here -->
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let inventory = JSON.parse(localStorage.getItem('boxshelvinv')) || {
            shelves: [],
            boxes: [],
            lastId: 0
        };
        let deletedItems = [];
        let viewMode = 'minimized'; // 'minimized' or 'expanded'
        let expandedItems = new Set(); // Track individually expanded items

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadInventory();
            updateStats();
            
            // Set initial view mode button text
            const viewToggleBtn = document.getElementById('viewToggle');
            if (viewToggleBtn) {
                viewToggleBtn.textContent = '📖 Expand All';
            }
            
            showNotification('Welcome to BoxShelvInv! 🎉', 'success');
        });

        // Add new shelf
        function addShelf() {
            const shelfNumber = ++inventory.lastId;
            const shelf = {
                id: shelfNumber,
                type: 'shelf',
                number: shelfNumber,
                items: []
            };
            
            inventory.shelves.push(shelf);
            saveInventory();
            renderShelf(shelf);
            updateStats();
            showNotification(`Shelf #${shelfNumber} added! 📚`, 'success');
        }

        // Add new box
        function addBox() {
            const boxNumber = ++inventory.lastId;
            const box = {
                id: boxNumber,
                type: 'box',
                number: boxNumber,
                items: []
            };
            
            inventory.boxes.push(box);
            saveInventory();
            renderBox(box);
            updateStats();
            showNotification(`Box #${boxNumber} added! 📦`, 'success');
        }

        // Render shelf
        function renderShelf(shelf) {
            const grid = document.getElementById('inventoryGrid');
            const shelfElement = document.createElement('div');
            const isExpanded = expandedItems.has(`shelf-${shelf.id}`);
            
            shelfElement.className = `shelf ${isExpanded ? 'expanded' : 'minimized'}`;
            shelfElement.id = `shelf-${shelf.id}`;
            
            shelfElement.innerHTML = `
                <div class="item-header ${isExpanded ? '' : 'minimized'}" onclick="toggleContainer('shelf', ${shelf.id})">
                    <div class="item-title">📚 Shelf</div>
                    <div class="item-number">#${shelf.number}</div>
                    ${!isExpanded ? `
                        <div class="minimized-info">
                            <span class="item-count">${shelf.items.length} items</span>
                            <button class="expand-btn" onclick="event.stopPropagation(); toggleContainer('shelf', ${shelf.id})">View</button>
                        </div>
                    ` : `
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteShelf(${shelf.id})">🗑️ Delete</button>
                    `}
                </div>
                
                <div class="content-area ${isExpanded ? '' : 'hidden'}">
                    <div class="add-item-form">
                        <input type="text" class="item-input" placeholder="Add item to shelf..." id="shelf-input-${shelf.id}">
                        <button class="add-item-btn" onclick="addItemToShelf(${shelf.id})">➕ Add</button>
                    </div>
                    
                    <div class="items-list" id="shelf-items-${shelf.id}">
                        ${shelf.items.map(item => `
                            <div class="item">
                                <span class="item-name">${item}</span>
                                <button class="item-delete-btn" onclick="removeItemFromShelf(${shelf.id}, '${item}')">✖️</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            grid.appendChild(shelfElement);
            
            // Add enter key support only if expanded
            if (isExpanded) {
                const input = document.getElementById(`shelf-input-${shelf.id}`);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addItemToShelf(shelf.id);
                        }
                    });
                }
            }
            
            // Add pulse animation
            shelfElement.classList.add('pulse');
            setTimeout(() => shelfElement.classList.remove('pulse'), 600);
        }

        // Render box
        function renderBox(box) {
            const grid = document.getElementById('inventoryGrid');
            const boxElement = document.createElement('div');
            const isExpanded = expandedItems.has(`box-${box.id}`);
            
            boxElement.className = `box ${isExpanded ? 'expanded' : 'minimized'}`;
            boxElement.id = `box-${box.id}`;
            
            boxElement.innerHTML = `
                <div class="item-header ${isExpanded ? '' : 'minimized'}" onclick="toggleContainer('box', ${box.id})">
                    <div class="item-title">📦 Box</div>
                    <div class="item-number">#${box.number}</div>
                    ${!isExpanded ? `
                        <div class="minimized-info">
                            <span class="item-count">${box.items.length} items</span>
                            <button class="expand-btn" onclick="event.stopPropagation(); toggleContainer('box', ${box.id})">View</button>
                        </div>
                    ` : `
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteBox(${box.id})">🗑️ Delete</button>
                    `}
                </div>
                
                <div class="content-area ${isExpanded ? '' : 'hidden'}">
                    <div class="add-item-form">
                        <input type="text" class="item-input" placeholder="Add item to box..." id="box-input-${box.id}">
                        <button class="add-item-btn" onclick="addItemToBox(${box.id})">➕ Add</button>
                    </div>
                    
                    <div class="items-list" id="box-items-${box.id}">
                        ${box.items.map(item => `
                            <div class="item">
                                <span class="item-name">${item}</span>
                                <button class="item-delete-btn" onclick="removeItemFromBox(${box.id}, '${item}')">✖️</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            grid.appendChild(boxElement);
            
            // Add enter key support only if expanded
            if (isExpanded) {
                const input = document.getElementById(`box-input-${box.id}`);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addItemToBox(box.id);
                        }
                    });
                }
            }
            
            // Add pulse animation
            boxElement.classList.add('pulse');
            setTimeout(() => boxElement.classList.remove('pulse'), 600);
        }

        // Toggle container expansion
        function toggleContainer(type, id) {
            const containerId = `${type}-${id}`;
            const container = document.getElementById(containerId);
            const contentArea = container.querySelector('.content-area');
            const header = container.querySelector('.item-header');
            
            if (expandedItems.has(containerId)) {
                // Minimize
                expandedItems.delete(containerId);
                container.classList.remove('expanded');
                container.classList.add('minimized');
                contentArea.classList.add('hidden');
                header.classList.add('minimized');
            } else {
                // Expand
                expandedItems.add(containerId);
                container.classList.remove('minimized');
                container.classList.add('expanded');
                contentArea.classList.remove('hidden');
                header.classList.remove('minimized');
                
                // Re-add event listeners for input fields
                setTimeout(() => {
                    const input = document.getElementById(`${type}-input-${id}`);
                    if (input) {
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                if (type === 'shelf') {
                                    addItemToShelf(id);
                                } else {
                                    addItemToBox(id);
                                }
                            }
                        });
                    }
                }, 100);
            }
            
            // Re-render to update the content
            setTimeout(() => {
                if (type === 'shelf') {
                    const shelf = inventory.shelves.find(s => s.id === id);
                    if (shelf) updateShelfDisplay(shelf);
                } else {
                    const box = inventory.boxes.find(b => b.id === id);
                    if (box) updateBoxDisplay(box);
                }
            }, 50);
        }

        // Toggle view mode for all items
        function toggleViewMode() {
            const button = document.getElementById('viewToggle');
            
            if (viewMode === 'minimized') {
                // Expand all
                viewMode = 'expanded';
                inventory.shelves.forEach(shelf => expandedItems.add(`shelf-${shelf.id}`));
                inventory.boxes.forEach(box => expandedItems.add(`box-${box.id}`));
                button.textContent = '📋 Minimize All';
                showNotification('All containers expanded! 📖', 'success');
            } else {
                // Minimize all
                viewMode = 'minimized';
                expandedItems.clear();
                button.textContent = '📖 Expand All';
                showNotification('All containers minimized! 📋', 'success');
            }
            
            loadInventory();
        }

        // Update shelf display without full re-render
        function updateShelfDisplay(shelf) {
            const container = document.getElementById(`shelf-${shelf.id}`);
            const isExpanded = expandedItems.has(`shelf-${shelf.id}`);
            
            container.innerHTML = `
                <div class="item-header ${isExpanded ? '' : 'minimized'}" onclick="toggleContainer('shelf', ${shelf.id})">
                    <div class="item-title">📚 Shelf</div>
                    <div class="item-number">#${shelf.number}</div>
                    ${!isExpanded ? `
                        <div class="minimized-info">
                            <span class="item-count">${shelf.items.length} items</span>
                            <button class="expand-btn" onclick="event.stopPropagation(); toggleContainer('shelf', ${shelf.id})">View</button>
                        </div>
                    ` : `
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteShelf(${shelf.id})">🗑️ Delete</button>
                    `}
                </div>
                
                <div class="content-area ${isExpanded ? '' : 'hidden'}">
                    <div class="add-item-form">
                        <input type="text" class="item-input" placeholder="Add item to shelf..." id="shelf-input-${shelf.id}">
                        <button class="add-item-btn" onclick="addItemToShelf(${shelf.id})">➕ Add</button>
                    </div>
                    
                    <div class="items-list" id="shelf-items-${shelf.id}">
                        ${shelf.items.map(item => `
                            <div class="item">
                                <span class="item-name">${item}</span>
                                <button class="item-delete-btn" onclick="removeItemFromShelf(${shelf.id}, '${item}')">✖️</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Update box display without full re-render
        function updateBoxDisplay(box) {
            const container = document.getElementById(`box-${box.id}`);
            const isExpanded = expandedItems.has(`box-${box.id}`);
            
            container.innerHTML = `
                <div class="item-header ${isExpanded ? '' : 'minimized'}" onclick="toggleContainer('box', ${box.id})">
                    <div class="item-title">📦 Box</div>
                    <div class="item-number">#${box.number}</div>
                    ${!isExpanded ? `
                        <div class="minimized-info">
                            <span class="item-count">${box.items.length} items</span>
                            <button class="expand-btn" onclick="event.stopPropagation(); toggleContainer('box', ${box.id})">View</button>
                        </div>
                    ` : `
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteBox(${box.id})">🗑️ Delete</button>
                    `}
                </div>
                
                <div class="content-area ${isExpanded ? '' : 'hidden'}">
                    <div class="add-item-form">
                        <input type="text" class="item-input" placeholder="Add item to box..." id="box-input-${box.id}">
                        <button class="add-item-btn" onclick="addItemToBox(${box.id})">➕ Add</button>
                    </div>
                    
                    <div class="items-list" id="box-items-${box.id}">
                        ${box.items.map(item => `
                            <div class="item">
                                <span class="item-name">${item}</span>
                                <button class="item-delete-btn" onclick="removeItemFromBox(${box.id}, '${item}')">✖️</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Add item to shelf
        function addItemToShelf(shelfId) {
            const input = document.getElementById(`shelf-input-${shelfId}`);
            const itemName = input.value.trim();
            
            if (!itemName) {
                showNotification('Please enter an item name! ⚠️', 'error');
                return;
            }
            
            const shelf = inventory.shelves.find(s => s.id === shelfId);
            if (shelf) {
                shelf.items.push(itemName);
                saveInventory();
                input.value = '';
                refreshShelf(shelf);
                updateStats();
                showNotification(`"${itemName}" added to Shelf #${shelf.number}! ✅`, 'success');
            }
        }

        // Add item to box
        function addItemToBox(boxId) {
            const input = document.getElementById(`box-input-${boxId}`);
            const itemName = input.value.trim();
            
            if (!itemName) {
                showNotification('Please enter an item name! ⚠️', 'error');
                return;
            }
            
            const box = inventory.boxes.find(b => b.id === boxId);
            if (box) {
                box.items.push(itemName);
                saveInventory();
                input.value = '';
                refreshBox(box);
                updateStats();
                showNotification(`"${itemName}" added to Box #${box.number}! ✅`, 'success');
            }
        }

        // Remove item from shelf
        function removeItemFromShelf(shelfId, itemName) {
            const shelf = inventory.shelves.find(s => s.id === shelfId);
            if (shelf) {
                const itemIndex = shelf.items.indexOf(itemName);
                if (itemIndex > -1) {
                    shelf.items.splice(itemIndex, 1);
                    deletedItems.push({
                        type: 'item',
                        container: 'shelf',
                        containerId: shelfId,
                        item: itemName,
                        timestamp: Date.now()
                    });
                    saveInventory();
                    refreshShelf(shelf);
                    updateStats();
                    showNotification(`"${itemName}" removed! 🗑️`, 'success');
                }
            }
        }

        // Remove item from box
        function removeItemFromBox(boxId, itemName) {
            const box = inventory.boxes.find(b => b.id === boxId);
            if (box) {
                const itemIndex = box.items.indexOf(itemName);
                if (itemIndex > -1) {
                    box.items.splice(itemIndex, 1);
                    deletedItems.push({
                        type: 'item',
                        container: 'box',
                        containerId: boxId,
                        item: itemName,
                        timestamp: Date.now()
                    });
                    saveInventory();
                    refreshBox(box);
                    updateStats();
                    showNotification(`"${itemName}" removed! 🗑️`, 'success');
                }
            }
        }

        // Delete shelf
        function deleteShelf(shelfId) {
            if (confirm('Are you sure you want to delete this shelf and all its items?')) {
                const shelfIndex = inventory.shelves.findIndex(s => s.id === shelfId);
                if (shelfIndex > -1) {
                    const shelf = inventory.shelves[shelfIndex];
                    deletedItems.push({
                        type: 'shelf',
                        data: shelf,
                        timestamp: Date.now()
                    });
                    inventory.shelves.splice(shelfIndex, 1);
                    saveInventory();
                    document.getElementById(`shelf-${shelfId}`).remove();
                    updateStats();
                    showNotification(`Shelf #${shelf.number} deleted! 🗑️`, 'success');
                }
            }
        }

        // Delete box
        function deleteBox(boxId) {
            if (confirm('Are you sure you want to delete this box and all its items?')) {
                const boxIndex = inventory.boxes.findIndex(b => b.id === boxId);
                if (boxIndex > -1) {
                    const box = inventory.boxes[boxIndex];
                    deletedItems.push({
                        type: 'box',
                        data: box,
                        timestamp: Date.now()
                    });
                    inventory.boxes.splice(boxIndex, 1);
                    saveInventory();
                    document.getElementById(`box-${boxId}`).remove();
                    updateStats();
                    showNotification(`Box #${box.number} deleted! 🗑️`, 'success');
                }
            }
        }

        // Undo delete
        function undoDelete() {
            if (deletedItems.length === 0) {
                showNotification('Nothing to undo! ⚠️', 'error');
                return;
            }

            const lastDeleted = deletedItems.pop();
            
            if (lastDeleted.type === 'shelf') {
                inventory.shelves.push(lastDeleted.data);
                saveInventory();
                renderShelf(lastDeleted.data);
                updateStats();
                showNotification(`Shelf #${lastDeleted.data.number} restored! ↶`, 'success');
            } else if (lastDeleted.type === 'box') {
                inventory.boxes.push(lastDeleted.data);
                saveInventory();
                renderBox(lastDeleted.data);
                updateStats();
                showNotification(`Box #${lastDeleted.data.number} restored! ↶`, 'success');
            } else if (lastDeleted.type === 'item') {
                if (lastDeleted.container === 'shelf') {
                    const shelf = inventory.shelves.find(s => s.id === lastDeleted.containerId);
                    if (shelf) {
                        shelf.items.push(lastDeleted.item);
                        saveInventory();
                        refreshShelf(shelf);
                        updateStats();
                        showNotification(`"${lastDeleted.item}" restored to Shelf #${shelf.number}! ↶`, 'success');
                    }
                } else if (lastDeleted.container === 'box') {
                    const box = inventory.boxes.find(b => b.id === lastDeleted.containerId);
                    if (box) {
                        box.items.push(lastDeleted.item);
                        saveInventory();
                        refreshBox(box);
                        updateStats();
                        showNotification(`"${lastDeleted.item}" restored to Box #${box.number}! ↶`, 'success');
                    }
                }
            }
        }

        // Refresh shelf display
        function refreshShelf(shelf) {
            if (expandedItems.has(`shelf-${shelf.id}`)) {
                updateShelfDisplay(shelf);
                // Re-add event listener for input
                setTimeout(() => {
                    const input = document.getElementById(`shelf-input-${shelf.id}`);
                    if (input) {
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                addItemToShelf(shelf.id);
                            }
                        });
                    }
                }, 100);
            } else {
                // Just update the item count in minimized view
                const countElement = document.querySelector(`#shelf-${shelf.id} .item-count`);
                if (countElement) {
                    countElement.textContent = `${shelf.items.length} items`;
                }
            }
        }

        // Refresh box display
        function refreshBox(box) {
            if (expandedItems.has(`box-${box.id}`)) {
                updateBoxDisplay(box);
                // Re-add event listener for input
                setTimeout(() => {
                    const input = document.getElementById(`box-input-${box.id}`);
                    if (input) {
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                addItemToBox(box.id);
                            }
                        });
                    }
                }, 100);
            } else {
                // Just update the item count in minimized view
                const countElement = document.querySelector(`#box-${box.id} .item-count`);
                if (countElement) {
                    countElement.textContent = `${box.items.length} items`;
                }
            }
        }

        // Search functionality
        function searchItems() {
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            const shelves = document.querySelectorAll('.shelf');
            const boxes = document.querySelectorAll('.box');
            
            [...shelves, ...boxes].forEach(container => {
                const items = container.querySelectorAll('.item-name');
                const title = container.querySelector('.item-title').textContent;
                const number = container.querySelector('.item-number').textContent;
                
                let hasMatch = title.toLowerCase().includes(searchTerm) || 
                              number.toLowerCase().includes(searchTerm);
                
                items.forEach(item => {
                    if (item.textContent.toLowerCase().includes(searchTerm)) {
                        hasMatch = true;
                        item.parentElement.style.backgroundColor = '#fffacd';
                    } else {
                        item.parentElement.style.backgroundColor = '';
                    }
                });
                
                container.style.display = hasMatch || searchTerm === '' ? 'block' : 'none';
            });
        }

        // Update statistics
        function updateStats() {
            const totalItems = inventory.shelves.reduce((sum, shelf) => sum + shelf.items.length, 0) +
                              inventory.boxes.reduce((sum, box) => sum + box.items.length, 0);
            
            document.getElementById('shelfCount').textContent = inventory.shelves.length;
            document.getElementById('boxCount').textContent = inventory.boxes.length;
            document.getElementById('itemCount').textContent = totalItems;
        }

        // Load inventory from localStorage
        function loadInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            
            inventory.shelves.forEach(shelf => renderShelf(shelf));
            inventory.boxes.forEach(box => renderBox(box));
        }

        // Save inventory to localStorage
        function saveInventory() {
            localStorage.setItem('boxshelvinv', JSON.stringify(inventory));
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Export inventory to JSON file
        function exportInventory() {
            try {
                const dataStr = JSON.stringify(inventory, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `boxshelvinv-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Inventory exported successfully! 💾', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Export failed! Please try again. ❌', 'error');
            }
        }

        // Trigger file input for import
        function importInventory() {
            document.getElementById('fileInput').click();
        }

        // Handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                showNotification('Please select a valid JSON file! ⚠️', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the imported data structure
                    if (!importedData.shelves || !importedData.boxes || typeof importedData.lastId === 'undefined') {
                        showNotification('Invalid inventory file format! ❌', 'error');
                        return;
                    }
                    
                    // Confirm before replacing current inventory
                    if (confirm('This will replace your current inventory. Are you sure you want to continue?')) {
                        inventory = importedData;
                        
                        // Reset expanded items state
                        expandedItems.clear();
                        viewMode = 'minimized';
                        document.getElementById('viewToggle').textContent = '📖 Expand All';
                        
                        // Save and reload
                        saveInventory();
                        loadInventory();
                        updateStats();
                        
                        showNotification(`Inventory imported successfully! 📁\nShelves: ${inventory.shelves.length}, Boxes: ${inventory.boxes.length}`, 'success');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showNotification('Failed to parse JSON file! Please check the file format. ❌', 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        }

        // Auto-hide search highlighting
        document.getElementById('searchBar').addEventListener('input', function() {
            if (this.value === '') {
                document.querySelectorAll('.item').forEach(item => {
                    item.style.backgroundColor = '';
                });
            }
        });

        // Clear old deleted items (older than 1 hour)
        setInterval(() => {
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            deletedItems = deletedItems.filter(item => item.timestamp > oneHourAgo);
        }, 300000); // Check every 5 minutes
    </script>
</body>
</html>